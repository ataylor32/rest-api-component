<script>
(function() {
    // Creates an object based in the HTML Element prototype
    var element = Object.create(HTMLElement.prototype, {
      source: {
        get: function() { return this._source; },
        set: function(value) {
          this._source = value;
          if (this.sourceElement) {
            this.unbind();
          }
          this.sourceElement = this.findElement(this._source);
          if (this.sourceElement) {
            this.bind();
          }
        }
      },
      target: {
        get: function() { return this._target; },
        set: function(value) {
          this._target = value;
          this.targetElement = this.findElement(this._target);
        }
      },
      dataChangedEvent: {
        get: function() {
          return this._dataChangedEvent || (this.attr + "-changed");
        },
        set: function(value) {
          this._dataChangedEvent = value;
        }
      },
      attr: {
        get: function() { return this._attr || "data"; },
        set: function(value) { this._attr = value; }
      },
      targetAttr: {
        get: function() { return this._targetAttr || this.attr; },
        set: function(value) { this._targetAttr = value; }
      }
    });

    element.bind = function() {
      if (this.sourceElement) {
        this.sourceElement.addEventListener(
          this.dataChangedEvent,
          this.handleDataChanged
        )
        this.handleDataChanged();
      }
    };

    element.unbind = function() {
      this.sourceElement.removeEventListener(
        this.dataChangedEvent, this.handleDataChanged);
    };

    element.findElement = function(selector) {
      var el = null;
      if (this.parentElement) {
        el = this.parentElement.querySelector(selector)
        if (! el) {
          el = document.querySelector(selector)
        }
      }
      console.log("finding", selector, el);
      return el;
    };

    element.handleDataChanged = function() {
      console.log("data changed!", this.sourceElement, this.targetElement, this.targetAttr, this.attr);
      if (this.sourceElement && this.targetElement) {
        this.targetElement[this.targetAttr] = this.sourceElement[this.attr];
      }
    };

    // Fires when an instance of the element is created
    element.createdCallback = function() {
    };

    // Fires when an instance was inserted into the document
    element.attachedCallback = function() {
      this.target = this.getAttribute("target");
      this.source = this.getAttribute("source");
      this.attr = this.getAttribute("attr");
      this.targetAttr = this.getAttribute("target-attr");
      this.dataChangedEvent = this.getAttribute("data-changed-event");
      this.bind();
    };

    // Fires when an instance was removed from the document
    element.detachedCallback = function() {
      this.unbind();
    };

    // Fires when an attribute was added, removed, or updated
    element.attributeChangedCallback = function(attr, oldVal, newVal) {
      console.log("attr changed", attr, oldVal, newVal);
    };

    // Registers custom element
    document.registerElement('bind-target', {
        prototype: element
    });
}());
</script>
